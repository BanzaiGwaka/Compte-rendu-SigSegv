# Conference Linux l'angle mort de la lutte anti-malware

Speaker : @IOxbot, pentest, vulndev, tooling

Etat des malwares sous Linux

	Halting problem : théoriquement impossible
	Au commencement:
		Backdoor programme login
		Bind/reverse shell (20 lignes de C, 1 ligne de bash/python,etc...)
		Crypto, port knocking, dns tunneling, etc...
	Webshell C99SHell (rudimentaire). Outils actuellement polymorphes, de pivot, etc...
	IRC bots (historique mais en baisse, utilisé pour scan/DDoS/Spreading, etc...)
	Actuellement : 
		ransomwares (depuis bitcoin)
		Mineurs de monnaie
		Services SSH modifiés (OpenSSH)
		Malwares APT "classiques" : NSA (60 commandes, écosystème complet)
		Modules apache / pam / whatever
		Mirai (botnet)
		
		Vraiment violent:
			Rootkits kernels qui modifient les flux http (insertion d'iframes dans trafic, décompression trafic compressé, insertion + recompression)
			Stager ELF full-memory over DNS
				Shellcode 1024 octets insérés dans syslogd, qui chargeait des payloads depuis du DNS
			VPNFilter
				Backdoor modulaire
				500000 routeurs infectés
		Furtivité:
			Yolo
			Camouflage (renommage en httpd du malware)
			Injection de code 
				Injectso (utilisation de ptrace pour charger un payload en .so pour camoufler le malware dans d'autres binaires)
			Rootkits userland
				Binaires patchés
				
			Rootkits kernel
				Moins répandu
				Plus furtif
				Mais nécessite d'être compilé pour le kernel cible
		Persistence:
			Pas de redémarrage souvent (donc des fois pas de persistence)
			Webshells
			Scripts d'init, de config, etc...
			Crontab, at
			/etc/ld.so.preload (utilisé par certaines versions de Mirai, charge le malware dans chaque utilitaire du système)
			Patch de binaires 
			Infection d'initramfs

	Malware
		ELF
		Script
		Stub/loader
		Code injecté dans fichier ou BDD
		Malware "fileless" dans monde Windows : existe depuis des années dans monde Linux
			

Comment marche un AV

	Malware trouvé sur client
	Récupération sample 
	Extraction signature
	Mise à jour des bases de signature

	Plus complexe maintenant:
		Bases de réputation
		Analyseurs de comportement
		Remontée aux éditeurs pour analyse


Pourquoi AV marche mal sous Linux

	Pas de malware sous Linux ? Faux !
	Cibles sont très hétérogènes (serveurs, routeurs, IOT, etc...)
	Equipement souvent fermés et peu adaptés (objets connectés, etc...)

	Actuellement une douzaine AV sous Linux
		Plus orientés scan de prévention/protection

	Clients poussés par la compliance 
	Kasp : 100000 signatures sous Linux, 7M sous Windows.

	Compliqué de créer un AV sous Linux:
		Environnement hétérogène (beaucoup de kernels, etc...)
		Services clients difficiles à gérer, peu de samples

	Difficultés techniques:
		Pas de sandbox, peu d'investissements R&D
		Limité à des fichiers connus, etc...


Remédiations

	Protection : 
		IOT : Modules LSM (Selinux, AppArmor, etc...). Super lourd à maintenir mais puissant (utilisé dans Android)
			IMA (Integrity Measurement Architecture). Fichier modifié => Kaput.

		DIY : fanotify(). Prévention lors de l'accès à des fichiers
			Combinaison avec Yara pour détection 
		Restreint aux malwares fichiers et connus
		Scans de mémoire
		Pas de bases de signatures, pas d'analyse comportementale)

	Détecter l'inconnu
		Installation FS
		Persistence
		Lancement
		Activité 

		Centraliser les évènements
		Etablissement d'une baseline et détection de comportements anormaux
		Collecte: auditd, sysdig, tripwire, bro
		Centralisation : Splunk, ELK, etc...

		Exemples:
			Apache lance crontab
			Chargement de bibliothèques suspectes
			Connexions
			Commandes Lancées
			LD_PRELOAD lancé

	Pas de télémétrie, pas de base
	Pas de base, pas de marché
	Pas de marché, pas de marché

	Surveillez les infras
		Logger
		Analyser
	Communiquer
	Problèmes des équipements fermés (IOT, équipements réseaux, etc...)



